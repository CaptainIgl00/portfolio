{
  admin off
}

champagnedevops.fr, www.champagnedevops.fr {
  encode zstd gzip
  root * /srv/www/portfolio/current
  try_files {path} /index.html
  file_server

  header {
    # Cache long pour assets fingerprintés
    @assets path_regexp \.(js|css|png|jpg|jpeg|svg|ico|webp|woff|woff2)$
    header @assets Cache-Control "public, max-age=31536000, immutable"
    
    # Pas de cache pour HTML (déploiements instantanés)
    @html path_regexp \.html$
    header @html Cache-Control "no-cache"
    
    # Sécurité de base
    X-Content-Type-Options nosniff
    Referrer-Policy no-referrer-when-downgrade
    X-Frame-Options DENY
    X-XSS-Protection "1; mode=block"
    
    # CSP pour plus de sécurité (ajuste selon tes besoins)
    Content-Security-Policy "default-src 'self'; img-src 'self' data: https:; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; script-src 'self'; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https:;"
  }

  # Gestion des erreurs
  handle_errors {
    @404 expression `{http.error.status_code} == 404`
    handle @404 {
      rewrite * /index.html
      file_server
    }
  }

  # Log des accès (optionnel, pour monitoring)
  log {
    output file /var/log/caddy/champagnedevops.fr.log {
      roll_size 100mb
      roll_keep 5
    }
    format json
  }
}
